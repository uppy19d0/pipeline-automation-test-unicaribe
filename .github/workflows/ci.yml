name: CI/CD - Comprehensive Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check Prettier formatting
        run: npm run format -- --check

  test:
    runs-on: ubuntu-latest
    needs: lint-and-format
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Si usas env en vez de config en package.json, descomenta:
      # - name: Configure JUnit env
      #   run: echo "JEST_JUNIT_OUTPUT=reports/junit/junit.xml" >> $GITHUB_ENV

      - name: Run tests with coverage + JUnit
        run: npm test

      - name: Publish test results (JUnit) to Checks
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Unit Tests (Jest)
          path: reports/junit/junit.xml
          reporter: jest-junit
          fail-on-error: false

      - name: Upload artifacts (reports + coverage)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-node-${{ matrix.node-version }}
          path: |
            reports/**
            coverage/**
          if-no-files-found: warn
          retention-days: 7

  docker-build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build (and load) Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: ci-simple-node-project:latest
          load: true                # <<<<<< CLAVE: carga la imagen al daemon local
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run container smoke test
        run: |
          set -e
          docker run -d --name test-container -p 3000:3000 ci-simple-node-project:latest
          # espera a que arranque
          for i in {1..30}; do
            if curl -fsS http://localhost:3000/health > /dev/null; then
              echo "Health OK"
              break
            fi
            sleep 1
            if [ $i -eq 30 ]; then
              echo "Healthcheck failed, dumping logs..."
              docker logs test-container || true
              exit 1
            fi
          done
          docker stop test-container
          docker rm test-container

    notify-email:
    runs-on: ubuntu-latest
    needs: [lint-and-format, test, docker-build]
    if: always() # el job corre siempre, pero los pasos de email se condicionan a tener secretos
    steps:
      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: test-artifacts-node-*
          merge-multiple: true

      # Envío si FALLA (solo si hay secretos y si es push)
      - name: Send email on failure
        if: failure() && github.event_name == 'push' &&
            secrets.SMTP_SERVER != '' && secrets.SMTP_PORT != '' &&
            secrets.SMTP_USERNAME != '' && secrets.SMTP_PASSWORD != '' &&
            secrets.SMTP_TO != '' && secrets.SMTP_FROM != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "❌ CI falló — ${{ github.repository }} #${{ github.run_number }}"
          from: "CI Bot <${{ secrets.SMTP_FROM }}>"
          to: ${{ secrets.SMTP_TO }}
          html_body: |
            <p>El pipeline <b>falló</b> para <code>${{ github.ref_name }}</code> en <code>${{ github.repository }}</code>.</p>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Ver ejecución</a></p>
          attachments: |
            reports/junit/junit.xml
            coverage/lcov.info
          nodemailerdebug: true

      # Envío si OK (solo si hay secretos y si es push)
      - name: Send email on success
        if: success() && github.event_name == 'push' &&
            secrets.SMTP_SERVER != '' && secrets.SMTP_PORT != '' &&
            secrets.SMTP_USERNAME != '' && secrets.SMTP_PASSWORD != '' &&
            secrets.SMTP_TO != '' && secrets.SMTP_FROM != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "✅ CI OK — ${{ github.repository }} #${{ github.run_number }}"
          from: "CI Bot <${{ secrets.SMTP_FROM }}>"
          to: ${{ secrets.SMTP_TO }}
          html_body: |
            <p>El pipeline <b>pasó</b> para <code>${{ github.ref_name }}</code> en <code>${{ github.repository }}</code>.</p>
            <ul>
              <li>Checks de pruebas publicados en la pestaña <i>Checks</i>.</li>
              <li>Artefactos: reportes y coverage adjuntos.</li>
            </ul>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Ver ejecución</a></p>
          attachments: |
            reports/junit/junit.xml
            coverage/lcov.info
          nodemailerdebug: true
